<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vercel Order Portal</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8 min-h-screen">

    <!-- Main application container -->
    <div id="app"></div>

    <!-- Spinner Overlay -->
    <div id="spinner-overlay" class="fixed top-0 left-0 w-full h-full bg-white bg-opacity-70 flex justify-center items-center z-[10000] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- Toast Message Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[9999]"></div>

    <script>
        // Use an object to manage the application state
        const state = {
            customer: null,
            items: [],
            filteredItems: [],
            cart: [],
            view: 'login', // 'login', 'store', 'cart'
            isLoading: false,
            mobile: '',
            password: '',
            shippingName: '',
            shippingMobile: '',
            shippingAddress: '',
            shippingPincode: '',
            searchInput: ''
        };

        // --- Apps Script API URL ---
        // IMPORTANT: This URL is taken from your previous input.
        const appScriptUrl = 'https://script.google.com/macros/s/AKfycbwaLptYzQxXJbLys2Qq7ZL3pQx8XSSyf4jOD3RPnJm4K5IETJ8G8W7ViKxUDxvbaAbk/exec';

        // --- API Functions using Fetch ---
        const api = {
            // Function to handle login via Apps Script
            checkLogin: (mobile, password) => {
                const url = new URL(appScriptUrl);
                url.searchParams.append('action', 'login');
                url.searchParams.append('mobile', mobile);
                url.searchParams.append('password', password);

                return fetch(url)
                    .then(response => response.json())
                    .catch(() => {
                        throw new Error('Network or server error during login.');
                    });
            },

            // Function to fetch items for a specific store via Apps Script
            getItems: (storeId) => {
                const url = new URL(appScriptUrl);
                url.searchParams.append('action', 'getItems');
                url.searchParams.append('storeId', storeId);

                return fetch(url)
                    .then(response => response.json())
                    .catch(() => {
                        throw new Error('Network or server error when fetching items.');
                    });
            },

            // Function to submit an order to Apps Script
            submitOrder: (payload) => {
                const url = new URL(appScriptUrl);
                url.searchParams.append('action', 'submitOrder');

                return fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .catch(() => {
                    throw new Error('Network or server error during order submission.');
                });
            }
        };

        // DOM Elements
        const appContainer = document.getElementById('app');
        const spinnerOverlay = document.getElementById('spinner-overlay');
        const toastContainer = document.getElementById('toast-container');

        // Show a toast message
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'info') bgColor = 'bg-blue-500';

            toast.className = `rounded-xl shadow-lg p-4 text-white flex items-center gap-4 ${bgColor}`;
            toast.innerHTML = `
                <span class="font-semibold text-lg">${message}</span>
                <button class="text-xl font-bold leading-none">&times;</button>
            `;
            toast.querySelector('button').addEventListener('click', () => toast.remove());
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Set loading state
        function setIsLoading(loading) {
            state.isLoading = loading;
            spinnerOverlay.style.display = loading ? 'flex' : 'none';
        }

        // Handle user login
        async function handleLogin() {
            if (!state.mobile || !state.password) {
                showToast('Please enter both mobile number and password.', 'error');
                return;
            }

            setIsLoading(true);
            try {
                const res = await api.checkLogin(state.mobile, state.password);
                if (res.status === 'success') {
                    state.customer = res.customer;
                    showToast('✅ Login successful');
                    state.view = 'store';
                    // The Apps Script function returns a direct array, so we don't access a .items property
                    const fetchedItems = await api.getItems(res.customer.StoreID);
                    state.items = fetchedItems;
                    state.filteredItems = [...fetchedItems];
                } else {
                    showToast('❌ Invalid login', 'error');
                }
            } catch (error) {
                showToast(`Login failed: ${error.message}`, 'error');
            } finally {
                setIsLoading(false);
                renderApp();
            }
        }

        // Handle user logout
        function handleLogout() {
            state.customer = null;
            state.items = [];
            state.cart = [];
            state.mobile = '';
            state.password = '';
            state.shippingName = '';
            state.shippingMobile = '';
            state.shippingAddress = '';
            state.shippingPincode = '';
            state.searchInput = '';
            state.view = 'login';
            showToast('👋 You have been logged out.', 'info');
            renderApp();
        }

        // Add an item to the cart
        function addToCart(item) {
            const itemIndex = state.cart.findIndex(cartItem => cartItem.ItemID === item.ItemID);
            if (itemIndex > -1) {
                state.cart[itemIndex].Qty++;
            } else {
                state.cart.push({ ...item, Qty: 1 });
            }
            showToast(`Added ${item.ItemName} to cart.`);
            renderApp();
        }

        // Remove an item from the cart
        function removeItem(itemId) {
            state.cart = state.cart.filter(cartItem => cartItem.ItemID !== itemId);
            showToast(`Removed from cart.`, 'info');
            renderApp();
        }

        // Handle order submission
        async function handleSubmitOrder() {
            if (state.cart.length === 0) {
                showToast('Your cart is empty. Please add items before placing an order.', 'error');
                return;
            }
            if (!state.shippingName || !state.shippingMobile || !state.shippingAddress || !state.shippingPincode) {
                showToast('Please fill in all shipping details.', 'error');
                return;
            }

            setIsLoading(true);
            const payload = {
                customer: {
                    LoginMobile: state.customer.Mobile,
                    LoginName: state.customer.Name
                },
                shipping: {
                    CustomerName: state.shippingName,
                    CustomerMobile: state.shippingMobile,
                    Address: state.shippingAddress,
                    Pincode: state.shippingPincode
                },
                cart: state.cart.map(item => ({
                    ItemID: item.ItemID,
                    ItemName: item.ItemName,
                    Rate: item.Rate,
                    Qty: item.Qty,
                    Amount: item.Rate * item.Qty
                }))
            };

            try {
                // The Apps Script now returns a JSON response which we can read.
                const res = await api.submitOrder(payload);
                if (res.status === 'success') {
                    showToast('✅ Order Placed! You should receive an update shortly.');
                    state.cart = []; // Clear cart
                    state.view = 'store'; // Return to store view
                } else {
                    showToast('Order failed. Please try again.', 'error');
                }
            } catch (error) {
                showToast(`Order submission failed: ${error.message}`, 'error');
            } finally {
                setIsLoading(false);
                renderApp();
            }
        }

        // Render the login view
        function renderLoginView() {
            appContainer.innerHTML = `
                <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg mt-8">
                    <h3 class="text-2xl sm:text-3xl font-semibold mb-6 text-center text-gray-800">🔐 Customer Login</h3>
                    <input
                        type="text"
                        id="mobileInput"
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Mobile Number"
                        value="${state.mobile}"
                    />
                    <input
                        type="password"
                        id="passwordInput"
                        class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Password"
                        value="${state.password}"
                    />
                    <button
                        id="loginBtn"
                        class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md text-base sm:text-lg"
                    >
                        Login
                    </button>
                </div>
            `;
            // Add event listeners
            document.getElementById('mobileInput').addEventListener('input', (e) => state.mobile = e.target.value);
            document.getElementById('passwordInput').addEventListener('input', (e) => state.password = e.target.value);
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
        }

        // Render the store view
        function renderStoreView() {
            const totalCartItems = state.cart.reduce((total, item) => total + item.Qty, 0);

            let itemsHtml = state.filteredItems.map(item => {
                const itemInCart = state.cart.find(ci => ci.ItemID === item.ItemID);
                const quantityInCart = itemInCart ? itemInCart.Qty : 0;
                const buttonText = quantityInCart > 0 ? `Add More (${quantityInCart})` : `Add to Cart`;
                const buttonColor = quantityInCart > 0 ? 'bg-green-500 hover:bg-green-600' : 'bg-blue-500 hover:bg-blue-600';

                return `
                    <div class="item-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-lg transition duration-300 ease-in-out flex flex-col justify-between">
                        <div>
                            <h6 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2">${item.ItemName}</h6>
                            <p class="text-gray-800 text-base sm:text-lg mb-4">₹${item.Rate.toFixed(2)}</p>
                        </div>
                        <button
                            class="w-full text-white px-4 py-2 rounded-md font-semibold transition duration-200 ease-in-out text-base sm:text-lg ${buttonColor}"
                            data-item-id="${item.ItemID}"
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            appContainer.innerHTML = `
                <div class="max-w-5xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg mt-8">
                    <div class="text-center mb-4">
                        <h2 class="text-3xl sm:text-4xl font-bold text-gray-800">${state.customer.StoreName}</h2>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-t pt-4">
                        <h4 class="text-xl sm:text-2xl font-medium text-green-600 mb-4 sm:mb-0">
                            Welcome, ${state.customer.Name}
                        </h4>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <button
                                id="viewCartBtn"
                                class="bg-purple-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md text-base sm:text-lg"
                            >
                                🛒 Cart (${totalCartItems})
                            </button>
                            <button
                                id="logoutBtn"
                                class="bg-red-600 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 ease-in-out shadow-md text-base sm:text-lg"
                            >
                                Logout
                            </button>
                        </div>
                    </div>
                    <div id="itemListingSection">
                        <input
                            type="text"
                            id="searchInput"
                            class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                            placeholder="Search items..."
                            value="${state.searchInput}"
                        />
                        <div id="items" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                            ${itemsHtml}
                        </div>
                    </div>
                </div>
            `;
            // Add event listeners
            document.getElementById('viewCartBtn').addEventListener('click', () => {
                state.view = 'cart';
                renderApp();
            });
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('searchInput').addEventListener('input', (e) => {
                state.searchInput = e.target.value;
                const q = state.searchInput.toLowerCase();
                state.filteredItems = state.items.filter(item => item.ItemName.toLowerCase().includes(q));
                renderApp();
            });
            document.querySelectorAll('.item-card button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    const item = state.items.find(i => i.ItemID === itemId);
                    if (item) addToCart(item);
                });
            });
        }

        // Render the cart view
        function renderCartView() {
            const cartTotal = state.cart.reduce((total, item) => total + item.Rate * item.Qty, 0).toFixed(2);

            let cartItemsHtml = '';
            if (state.cart.length === 0) {
                cartItemsHtml = `<p class="text-gray-600 italic text-base sm:text-lg">Your cart is empty.</p>`;
            } else {
                cartItemsHtml = state.cart.map(item => `
                    <div class="flex justify-between items-center py-3 border-b border-gray-200 last:border-b-0">
                        <span class="text-gray-800 text-base sm:text-lg">${item.ItemName} x ${item.Qty}</span>
                        <div class="flex items-center space-x-2 sm:space-x-4">
                            <span class="text-gray-900 font-medium text-base sm:text-lg">₹${(item.Qty * item.Rate).toFixed(2)}</span>
                            <button
                                class="bg-red-500 text-white px-2 py-1 sm:px-3 rounded-md text-sm sm:text-base font-semibold hover:bg-red-600 transition"
                                data-item-id="${item.ItemID}"
                            >
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('');
                cartItemsHtml += `
                    <div class="mt-4 pt-4 border-t-2 border-gray-300 flex justify-between items-center">
                        <span class="text-lg sm:text-xl font-bold text-gray-900">Total:</span>
                        <span class="text-lg sm:text-xl font-bold text-gray-900">₹${cartTotal}</span>
                    </div>
                `;
            }

            appContainer.innerHTML = `
                <div class="max-w-5xl mx-auto bg-white p-4 sm:p-6 rounded-xl shadow-lg mt-8">
                    <button
                        id="backToStoreBtn"
                        class="bg-gray-500 text-white px-4 py-2 sm:px-5 sm:py-2 rounded-lg font-semibold hover:bg-gray-600 transition duration-300 ease-in-out shadow-md mb-6 text-base sm:text-lg"
                    >
                        &larr; Back to Shopping
                    </button>
                    <h5 class="text-2xl sm:text-3xl font-semibold mb-4 text-gray-800">🛒 Your Cart</h5>
                    <div id="cart" class="mb-8 border border-gray-200 rounded-lg p-4 bg-gray-50">
                        ${cartItemsHtml}
                    </div>
                    <h5 class="text-2xl sm:text-3xl font-semibold mb-4 text-gray-800">🚚 Shipping Details</h5>
                    <input
                        type="text"
                        id="shippingNameInput"
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Customer Name"
                        value="${state.shippingName}"
                    />
                    <input
                        type="text"
                        id="shippingMobileInput"
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Mobile Number"
                        value="${state.shippingMobile}"
                    />
                    <textarea
                        id="shippingAddressInput"
                        class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Full Address"
                        rows="3"
                    >${state.shippingAddress}</textarea>
                    <input
                        type="text"
                        id="shippingPincodeInput"
                        class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg"
                        placeholder="Pincode"
                        value="${state.shippingPincode}"
                    />
                    <button
                        id="submitBtn"
                        class="w-full bg-green-600 text-white p-3 sm:p-4 rounded-lg font-semibold hover:bg-green-700 transition duration-300 ease-in-out shadow-md text-lg sm:text-xl ${state.cart.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${state.cart.length === 0 ? 'disabled' : ''}
                    >
                        Place Order
                    </button>
                </div>
            `;
            // Add event listeners
            document.getElementById('backToStoreBtn').addEventListener('click', () => {
                state.view = 'store';
                renderApp();
            });
            document.getElementById('shippingNameInput').addEventListener('input', (e) => state.shippingName = e.target.value);
            document.getElementById('shippingMobileInput').addEventListener('input', (e) => state.shippingMobile = e.target.value);
            document.getElementById('shippingAddressInput').addEventListener('input', (e) => state.shippingAddress = e.target.value);
            document.getElementById('shippingPincodeInput').addEventListener('input', (e) => state.shippingPincode = e.target.value);
            document.getElementById('submitBtn').addEventListener('click', handleSubmitOrder);
            document.querySelectorAll('#cart button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.itemId;
                    if (itemId) removeItem(itemId);
                });
            });
        }

        // Main render function
        function renderApp() {
            switch (state.view) {
                case 'login':
                    renderLoginView();
                    break;
                case 'store':
                    renderStoreView();
                    break;
                case 'cart':
                    renderCartView();
                    break;
            }
        }

        // Initial render on page load
        window.onload = () => {
            renderApp();
        };

    </script>
</body>
</html>

